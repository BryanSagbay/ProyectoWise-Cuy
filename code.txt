import rclpy
from rclpy.node import Node
import cv2
import os
from datetime import datetime

class WebcamNode(Node):
    def __init__(self):
        super().__init__('webcam_node')
        self.get_logger().info("Webcam node started")
        self.cap = cv2.VideoCapture(0)  # Asegúrate de que el índice coincide con tu cámara
        self.timer = self.create_timer(0.1, self.show_camera)
        self.image_save_dir = os.path.join(os.getcwd(), 'images')
        os.makedirs(self.image_save_dir, exist_ok=True)

    def show_camera(self):
        ret, frame = self.cap.read()
        if ret:
            cv2.imshow('Webcam', frame)

            # Presiona 's' para guardar una imagen
            key = cv2.waitKey(1) & 0xFF
            if key == ord('s'):
                filename = datetime.now().strftime('%Y%m%d_%H%M%S') + '.jpg'
                filepath = os.path.join(self.image_save_dir, filename)
                cv2.imwrite(filepath, frame)
                self.get_logger().info(f"Image saved: {filepath}")
            elif key == ord('q'):
                self.get_logger().info("Exiting webcam node")
                self.cap.release()
                cv2.destroyAllWindows()
                rclpy.shutdown()

def main(args=None):  # Cambia aquí para que args sea opcional
    rclpy.init(args=args)
    node = WebcamNode()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()



from setuptools import setup

package_name = 'webcam_pkg'

setup(
    name=package_name,
    version='0.1.0',
    packages=[package_name],
    data_files=[
        ('share/ament_index/resource_index/packages', ['resource/' + package_name]),
        ('share/' + package_name, ['package.xml']),
    ],
    install_requires=['setuptools', 'opencv-python'],
    zip_safe=True,
    maintainer='tu_nombre',
    maintainer_email='tu_email@example.com',
    description='Paquete de ROS2 para manejar webcam y guardar imágenes.',
    license='Apache License 2.0',
    tests_require=['pytest'],
    entry_points={
        'console_scripts': [
            'webcam_node = webcam_pkg.webcam_node:main',  # Asegúrate de que este mapeo sea correcto
        ],
    },
)
